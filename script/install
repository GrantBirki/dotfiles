#!/bin/bash
############################
# This script creates symlinks from the home directory to any desired dotfiles in ~/dotfiles/dotfiles
############################

if [[ "$CODESPACES" == "true" ]]; then
    echo "detected GitHub codespace"
    # ~/.vscode-remote might need to be deleted
fi

# Determine if the system is a Mac or Linux
os="unknown"
if [[ "$OSTYPE" == "linux-gnu" ]]; then
    echo "Linux detected"
    gitconfig=".gitconfig_linux"
    os="linux"
elif [[ "$OSTYPE" == "darwin"* ]]; then
    echo "Mac detected"
    gitconfig=".gitconfig_mac"
    os="mac"
else
    echo "Unknown OS (or Windows) using defaults"
    gitconfig=".gitconfig"
fi

########## Variables

DOTFILES_REPO_DIR="dotfiles"
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd .. && pwd )" # dotfiles directory
OLDDIR=~/dotfiles_old # old dotfiles backup directory
OPENAI_MARKER="$HOME/.openai_laptop"
OPENAI_LAPTOP=false

if [ -f "$OPENAI_MARKER" ]; then
    echo "OpenAI laptop detected (found $OPENAI_MARKER)"
    OPENAI_LAPTOP=true
fi

if $OPENAI_LAPTOP; then
    gitconfig=".gitconfig_openai"
    BASHRC_SRC=".bashrc_openai"
    BASH_ALIASES_SRC=".bash_aliases_openai"
else
    BASHRC_SRC=".bashrc"
    BASH_ALIASES_SRC=".bash_aliases"
fi

FILES_TO_LINK=(
    "$BASHRC_SRC:.bashrc"
    "$BASH_ALIASES_SRC:.bash_aliases"
    ".bash_logout:.bash_logout"
    ".profile:.profile"
    ".rubocop.yml:.rubocop.yml"
    ".irbrc:.irbrc"
)

link_file() {
    local source_file=$1
    local target_name=$2
    local source_path="$DIR/$DOTFILES_REPO_DIR/$source_file"
    local target_path="$HOME/$target_name"
    local backup_target="$OLDDIR/$target_name"

    if [ ! -e "$source_path" ]; then
        echo "Source $source_path does not exist, skipping."
        return
    fi

    if [ -L "$target_path" ] && [ "$(readlink "$target_path")" == "$source_path" ]; then
        echo "$target_path already linked to $source_file, skipping."
        return
    fi

    if [ -e "$target_path" ] || [ -L "$target_path" ]; then
        if [ "$target_path" -ef "$backup_target" ]; then
            echo "$target_path already resides in backup, skipping move."
        else
            echo "Moving existing $target_path from ~/ to $OLDDIR"
            mv "$target_path" "$OLDDIR/"
        fi
    else
        echo "No existing $target_path found, creating fresh link."
    fi

    rm -f "$target_path"
    echo "Creating symlink to $source_file at $target_path"
    ln -s "$source_path" "$target_path"
}

##########

# create dotfiles_old in homedir
echo -n "Creating $OLDDIR for backup of any existing dotfiles in ~/ ..."
mkdir -p $OLDDIR

# move any existing dotfiles in homedir to dotfiles_old directory, then create symlinks from the homedir to any files in the dotfiles directory specified in FILES_TO_LINK
for mapping in "${FILES_TO_LINK[@]}"; do
    IFS=":" read -r source_file target_name <<< "$mapping"
    link_file "$source_file" "$target_name"
done

# if we are on a mac, symlink the .bashrc file to the .zshrc file
if [[ $os == "mac" ]]; then
    if [ -e ~/.zshrc ] || [ -L ~/.zshrc ]; then
        echo "Moving any existing .zshrc from ~/ to $OLDDIR"
        mv ~/.zshrc ~/dotfiles_old/
    else
        echo "No existing .zshrc found, skipping move."
    fi
    # echo "Creating symlink to .zshrc from .bashrc ~/"
    # ln -s $DIR/$DOTFILES_REPO_DIR/.bashrc ~/.zshrc

    # move karabiner.json to the correct location if the .config/karabiner directory exists
    if [ -d ~/.config/karabiner ]; then
        echo "Moving any existing karabiner.json from ~/ to $OLDDIR/.config/karabiner"
        mkdir -p ~/dotfiles_old/.config/karabiner
        if [ -e ~/.config/karabiner/karabiner.json ] || [ -L ~/.config/karabiner/karabiner.json ]; then
            mv ~/.config/karabiner/karabiner.json ~/dotfiles_old/.config/karabiner/
        fi
        echo "Creating symlink to karabiner.json in ~/.config/karabiner"
        rm -f ~/.config/karabiner/karabiner.json
        ln -s $DIR/configs/karabiner/karabiner.json ~/.config/karabiner/karabiner.json
        echo "Note: select ANSI if prompted by Karabiner-Elements"
    else
        echo "No karabiner.json found in ~/.config/karabiner - it will be skipped"
    fi

    # move configs/alacritty/alacritty_mac.toml to the correct location if the .config/alacritty directory exists
    if [ -d ~/.config/alacritty ]; then
        echo "Moving any existing alacritty config from ~/ to $OLDDIR/.config/alacritty"
        mkdir -p ~/dotfiles_old/.config/alacritty
        if [ -e ~/.config/alacritty/alacritty.toml ] || [ -L ~/.config/alacritty/alacritty.toml ]; then
            mv ~/.config/alacritty/alacritty.toml ~/dotfiles_old/.config/alacritty/
        fi
        echo "Creating symlink to alacritty config in ~/.config/alacritty"
        rm -f ~/.config/alacritty/alacritty.toml
        ln -s $DIR/configs/alacritty/alacritty_mac.toml ~/.config/alacritty/alacritty.toml
    else
        echo "No alacritty config found in ~/.config/alacritty - it will be skipped"
    fi
fi

# custom .gitconfig logic
if [[ "$CODESPACES" != "true" ]]; then
    if [ -L ~/.gitconfig ] && [ "$(readlink ~/.gitconfig)" == "$DIR/$DOTFILES_REPO_DIR/$gitconfig" ]; then
        echo "~/.gitconfig already linked to $gitconfig, skipping."
    else
        echo "Moving any existing .gitconfig from ~/ to $OLDDIR"
        if [ -e ~/.gitconfig ] || [ -L ~/.gitconfig ]; then
            mv ~/.gitconfig ~/dotfiles_old/
        fi
        echo "Creating symlink to $gitconfig in ~/"
        rm -f ~/.gitconfig
        ln -s $DIR/$DOTFILES_REPO_DIR/$gitconfig ~/.gitconfig
    fi
else
    # If we don't skip it, it almost always breaks commit signing / pushes
    echo "CODESPACES detected: skipping .gitconfig symlink."
fi

echo "Make sure to run 'source ~/.bashrc' to finish applying changes."

echo "Done!"
