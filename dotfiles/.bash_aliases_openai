# https://github.com/GrantBirki/dotfiles

alias ll='ls -lah'
alias la='ls -A'
alias l='ls -CF'
alias c='clear'
alias cdc='cd ~/code || cd /mnt/c/code'
alias gbr='git branch | grep -v -E "(master|main)" | xargs git branch -D'
alias gpf='git fetch --all && echo -e "\033[1;34m[#]\033[0m Creating Backup Branch: backup-$(git symbolic-ref --short -q HEAD)" && git branch backup-$(git symbolic-ref --short -q HEAD) && echo -e "\033[1;34m[#]\033[0m Force Pull Current Branch from Remote Origin" && git reset --hard origin/$(git symbolic-ref --short -q HEAD) && echo -e "\033[1;34m[#]\033[0m Current Branch is set to state of remote Origin and backup branch created."'
alias gcm='git checkout master 2> /dev/null || echo "master branch not found, trying main"; git checkout main'
alias lss='exa -lag --time-style=long-iso'
alias h='history | rg -i'
alias dockernuke='docker rm -vf $(docker ps -a -q) && docker rmi -f $(docker images -a -q) && docker system prune -a --volumes'
alias pbcopy='xsel --clipboard --input'
alias pbpaste='xsel --clipboard --output'
alias pss='ps -auxf | head -1 ; ps -auxf | grep -i'
alias ssh="TERM=xterm-256color $(which ssh)"

# if the platform is mac, use the mac aliases
if [[ "$OSTYPE" == "darwin"* ]]; then
    alias tailscale="/Applications/Tailscale.app/Contents/MacOS/Tailscale"
fi

OPENAI_MARKER="$HOME/.openai_laptop"
OPENAI_NON_OPENAI_KEY_DEFAULT="${OPENAI_NON_OPENAI_KEY_DEFAULT:-/Users/birki/Library/Containers/com.maxgoedjen.Secretive.SecretAgent/Data/PublicKeys/acf6b2512de58191c13bd9b82aa88451.pub}"
OPENAI_WORK_KEY_DEFAULT="${OPENAI_WORK_KEY_DEFAULT:-/Users/birki/Library/Containers/com.maxgoedjen.Secretive.SecretAgent/Data/PublicKeys/4f89cb94f1b4f8d173bdf80b8d050674.pub}"

choose_non_openai_key() {
    local key_path
    read -r -p "Path to non-OpenAI Secretive key [$OPENAI_NON_OPENAI_KEY_DEFAULT]: " key_path
    key_path=${key_path:-$OPENAI_NON_OPENAI_KEY_DEFAULT}
    if [ ! -f "$key_path" ]; then
        echo "Key not found at $key_path" >&2
        return 1
    fi
    printf "%s" "$key_path"
}

gclone() {
    if [ -z "$1" ]; then
        echo "Usage: gclone <repo-url> [destination]" >&2
        return 1
    fi

    local repo_url=$1
    shift

    local is_openai="y"
    if [ -f "$OPENAI_MARKER" ]; then
        read -r -p "Is this an OpenAI repo? [Y/n]: " is_openai
        is_openai=${is_openai:-y}
    fi

    local dest_arg="$1"
    local repo_dir=${dest_arg:-$(basename "${repo_url%.git}")}
    local clone_cmd=(git clone "$repo_url")
    if [ -n "$dest_arg" ]; then
        clone_cmd+=("$dest_arg")
    fi

    if [[ $is_openai =~ ^[Yy]$ ]]; then
        "${clone_cmd[@]}"
        return $?
    fi

    local key_path
    key_path=$(choose_non_openai_key) || return 1

    local identity_agent="${SSH_AUTH_SOCK:-$OPENAI_SECRETIVE_SOCKET}"
    local ssh_cmd="ssh -o IdentitiesOnly=yes"
    if [ -n "$identity_agent" ]; then
        ssh_cmd="$ssh_cmd -o IdentityAgent=$identity_agent"
    fi
    ssh_cmd="$ssh_cmd -o IdentityFile=$key_path"

    GIT_SSH_COMMAND="$ssh_cmd" "${clone_cmd[@]}"

    if [ -d "$repo_dir/.git" ]; then
        (cd "$repo_dir" && git config --local core.sshCommand "$ssh_cmd")
    else
        echo "Skipped git config: $repo_dir/.git not found" >&2
    fi
}
alias gcl='gclone'

gpull_fn() {
    local answer="y"
    if [ -f "$OPENAI_MARKER" ]; then
        read -r -p "Is this an OpenAI repo for git pull? [Y/n]: " answer
        answer=${answer:-y}
    fi

    if [[ $answer =~ ^[Yy]$ ]]; then
        git pull "$@"
        return $?
    fi

    if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        echo "gp must be run inside a git repository." >&2
        return 1
    fi

    local key_path
    key_path=$(choose_non_openai_key) || return 1

    local identity_agent="${SSH_AUTH_SOCK:-$OPENAI_SECRETIVE_SOCKET}"
    local ssh_cmd="ssh -o IdentitiesOnly=yes"
    if [ -n "$identity_agent" ]; then
        ssh_cmd="$ssh_cmd -o IdentityAgent=$identity_agent"
    fi
    ssh_cmd="$ssh_cmd -o IdentityFile=$key_path"

    GIT_SSH_COMMAND="$ssh_cmd" git pull "$@"
    git config --local core.sshCommand "$ssh_cmd"
}

alias gp='git pull'
alias gpull='gpull_fn'
alias gc='gclone'
